<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>Admin Panel - SearchZone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ===== DARK THEME VARIABLES ===== */
        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #14181c;
            --bg-card: #1e2428;
            --bg-hover: #2a3138;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --text-muted: #8a8f99;
            --accent-primary: #6c5ce7;
            --accent-secondary: #a463f5;
            --accent-success: #00b894;
            --accent-warning: #fdcb6e;
            --accent-danger: #d63031;
            --border-color: #2d343e;
            --shadow-color: rgba(0, 0, 0, 0.5);
            
            /* Category Colors */
            --category-anime: #ff6b6b;
            --category-movies: #4ecdc4;
            --category-software: #a8e6cf;
            --category-books: #ffd93d;
            --category-games: #6c5ce7;
            --category-music: #ff9ff3;
            --category-other: #8395a7;

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-xxl: 24px;
            --spacing-xxxl: 32px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: -webkit-fill-available;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            line-height: 1.5;
            padding: var(--spacing-lg);
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* ===== LOGIN OVERLAY ===== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xxxl);
            box-shadow: 0 20px 60px var(--shadow-color);
            max-width: 450px;
            width: 100%;
            margin: auto;
            border: 1px solid var(--border-color);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-xxl);
        }

        .login-icon {
            font-size: 3rem;
            color: var(--accent-primary);
            margin-bottom: var(--spacing-lg);
        }

        .login-header h2 {
            color: var(--text-primary);
            font-size: clamp(1.5rem, 6vw, 2rem);
            margin-bottom: var(--spacing-sm);
        }

        .login-header p {
            color: var(--text-muted);
        }

        /* ===== SECURITY BADGES ===== */
        .security-badge {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(108, 92, 231, 0.1);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            margin-bottom: var(--spacing-lg);
            font-size: 0.85rem;
            border: 1px solid var(--accent-primary);
        }

        .security-badge i {
            color: var(--accent-primary);
        }

        .session-info {
            position: fixed;
            top: 20px;
            right: 100px;
            background: var(--bg-card);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .session-info i {
            color: var(--accent-success);
        }

        .session-timer {
            color: var(--accent-warning);
            font-weight: 600;
            margin-left: var(--spacing-sm);
        }

        /* ===== ADMIN CONTENT ===== */
        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        /* ===== HEADER ACTIONS ===== */
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xxl);
            flex-wrap: wrap;
            gap: var(--spacing-md);
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-primary);
            padding: var(--spacing-md) 0;
        }

        .back-link, .logout-btn {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-full);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .logout-btn {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            color: white;
            cursor: pointer;
            border: none;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(214, 48, 49, 0.3);
        }

        .back-link:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .header-title {
            text-align: center;
            flex: 1;
        }

        .header-title h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            background: linear-gradient(135deg, #6c5ce7, #a463f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: var(--spacing-xs);
        }

        .header-title p {
            color: var(--text-secondary);
            font-size: clamp(0.85rem, 3vw, 1.1rem);
        }

        /* Rest of the CSS remains the same as before... */
        /* [Keep all the existing CSS from your admin.html] */

        /* Add these new security styles */
        .login-footer {
            margin-top: var(--spacing-xl);
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
            padding-top: var(--spacing-lg);
        }

        .login-footer i {
            color: var(--accent-success);
            margin: 0 var(--spacing-xs);
        }

        .login-attempts {
            font-size: 0.8rem;
            color: var(--accent-warning);
            margin-top: var(--spacing-sm);
        }

        .error-message, .rate-limit-warning {
            display: none;
            background: rgba(214, 48, 49, 0.1);
            color: var(--accent-danger);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            border-left: 4px solid var(--accent-danger);
        }

        .rate-limit-warning {
            background: rgba(253, 203, 110, 0.1);
            color: var(--accent-warning);
            border-left-color: var(--accent-warning);
        }

        /* Session timeout warning */
        .timeout-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            padding: var(--spacing-xxxl);
            border-radius: var(--radius-xl);
            border: 2px solid var(--accent-warning);
            z-index: 10002;
            text-align: center;
            max-width: 400px;
            width: 90%;
            display: none;
        }

        .timeout-warning.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .timeout-warning i {
            font-size: 3rem;
            color: var(--accent-warning);
            margin-bottom: var(--spacing-lg);
        }

        .timeout-warning h3 {
            margin-bottom: var(--spacing-md);
        }

        .timeout-warning p {
            color: var(--text-muted);
            margin-bottom: var(--spacing-xl);
        }

        .timeout-buttons {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
        }

        /* Activity indicator */
        .activity-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .activity-indicator i {
            color: var(--accent-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Prevent right-click on sensitive areas */
        .sensitive-area {
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- Session Info (visible when logged in) -->
    <div class="session-info" id="sessionInfo" style="display: none;">
        <i class="fas fa-shield-alt"></i>
        <span>Secure Session</span>
        <span class="session-timer" id="sessionTimer"></span>
    </div>

    <!-- Activity Indicator -->
    <div class="activity-indicator" id="activityIndicator" style="display: none;">
        <i class="fas fa-circle"></i>
        <span>Session Active</span>
    </div>

    <!-- Session Timeout Warning -->
    <div class="timeout-warning" id="timeoutWarning">
        <i class="fas fa-clock"></i>
        <h3>Session Expiring Soon</h3>
        <p>Your session will expire in <span id="timeoutCountdown">2 minutes</span></p>
        <div class="timeout-buttons">
            <button class="btn btn-primary" onclick="extendSession()">
                <i class="fas fa-hourglass-start"></i> Stay Logged In
            </button>
            <button class="btn btn-secondary" onclick="forceLogout()">
                <i class="fas fa-sign-out-alt"></i> Logout Now
            </button>
        </div>
    </div>

    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <div class="login-header">
                <div class="login-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2>Secure Admin Login</h2>
                <p>Enter your credentials to access admin panel</p>
            </div>

            <!-- Security Badge -->
            <div class="security-badge">
                <i class="fas fa-lock"></i>
                <span>Protected by rate limiting & session management</span>
            </div>

            <div id="loginError" class="error-message"></div>
            <div id="rateLimitWarning" class="rate-limit-warning"></div>

            <form id="loginForm" autocomplete="off">
                <div class="form-group">
                    <label for="username">
                        <i class="fas fa-user" style="margin-right: var(--spacing-sm);"></i>Username
                    </label>
                    <input 
                        type="text" 
                        id="username" 
                        placeholder="Enter username"
                        autocomplete="off"
                        required
                        maxlength="50"
                    >
                </div>

                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-key" style="margin-right: var(--spacing-sm);"></i>Password
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        placeholder="Enter password"
                        autocomplete="off"
                        required
                        maxlength="50"
                    >
                </div>

                <button type="submit" class="btn btn-primary btn-block" style="width: 100%;" id="loginButton">
                    <i class="fas fa-lock-open"></i> Login Securely
                </button>

                <div class="login-attempts" id="loginAttempts"></div>
            </form>

            <div class="login-footer">
                <i class="fas fa-shield-alt"></i> 256-bit Encryption â€¢ <i class="fas fa-clock"></i> 2hr Session â€¢ <i class="fas fa-ban"></i> 5 Attempt Max
            </div>
        </div>
    </div>

    <!-- Admin Content -->
    <div class="admin-content" id="adminContent">
        <!-- Header Actions -->
        <div class="header-actions">
            <a href="index.html" class="back-link">
                <i class="fas fa-arrow-left"></i> 
                <span class="hide-mobile">Back to Search</span>
                <span class="show-mobile" style="display: none;">Back</span>
            </a>
            
            <div class="header-title">
                <h1><i class="fas fa-cog"></i> Admin Panel</h1>
                <p>Manage archives with multi-category support</p>
            </div>
            
            <button class="logout-btn" onclick="logout()" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i> 
                <span class="hide-mobile">Secure Logout</span>
                <span class="show-mobile" style="display: none;">Exit</span>
            </button>
        </div>

        <!-- Rest of admin content remains the same -->
        <div class="container">
            <!-- Category Statistics -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-chart-pie" style="color: var(--accent-primary);"></i>
                    <h3>Category Overview</h3>
                </div>
                <div class="category-stats-grid" id="categoryStats"></div>
            </div>

            <!-- Add Archive Form -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-plus-circle" style="color: var(--accent-primary);"></i>
                    <h3>Add New Archive</h3>
                </div>
                
                <form id="addArchiveForm">
                    <div class="form-grid">
                        <div>
                            <div class="form-group">
                                <label for="archiveName">Archive Name *</label>
                                <input type="text" id="archiveName" placeholder="e.g., AnimeFlix, MoviesMod" required maxlength="100">
                            </div>

                            <div class="form-group">
                                <label for="archiveUrl">Website URL *</label>
                                <input type="text" id="archiveUrl" placeholder="e.g., animeflix.town" required maxlength="200">
                            </div>

                            <div class="form-group">
                                <label for="archiveSearchPattern">Search URL Pattern</label>
                                <input type="text" id="archiveSearchPattern" placeholder="/?s={query} or /search?q={query}" maxlength="200">
                                <div class="form-hint">Use {query} as placeholder for search term</div>
                            </div>
                        </div>

                        <div>
                            <div class="form-group">
                                <label>Categories * (select one or more)</label>
                                <div class="checkbox-group" id="categoryCheckboxes"></div>
                                <div class="form-hint">Select all categories that apply to this archive</div>
                            </div>

                            <div class="form-group">
                                <label for="archiveDescription">Description</label>
                                <textarea id="archiveDescription" placeholder="What content can users find here?" maxlength="500"></textarea>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-top: var(--spacing-xl);">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i> Add Archive
                        </button>
                    </div>
                </form>
            </div>

            <!-- Bulk Category Management -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-tags" style="color: var(--accent-primary);"></i>
                    <h3>Bulk Category Management</h3>
                </div>
                
                <div class="bulk-actions">
                    <select id="bulkCategorySelect" class="category-select">
                        <option value="">Select category to add/remove</option>
                        <option value="anime">ðŸŽ¬ Anime</option>
                        <option value="movies">ðŸŽ¥ Movies & TV</option>
                        <option value="software">ðŸ’» Software</option>
                        <option value="books">ðŸ“š Books & Comics</option>
                        <option value="games">ðŸŽ® Games</option>
                        <option value="music">ðŸŽµ Music</option>
                        <option value="other">ðŸ“¦ Other</option>
                    </select>
                    
                    <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="addBulkCategory()">
                            <i class="fas fa-plus"></i> Add
                        </button>
                        <button class="btn btn-danger" onclick="removeBulkCategory()">
                            <i class="fas fa-minus"></i> Remove
                        </button>
                        <button class="btn btn-secondary" onclick="selectAllArchives()">
                            <i class="fas fa-check-square"></i> Select All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Archives Management -->
            <div class="admin-card">
                <div class="card-header">
                    <i class="fas fa-list" style="color: var(--accent-primary);"></i>
                    <h3>Manage Archives</h3>
                </div>
                
                <!-- Category Filter -->
                <div class="filter-buttons">
                    <button class="filter-btn" onclick="filterArchivesByCategory('all')">
                        <i class="fas fa-globe"></i> All
                    </button>
                    <button class="filter-btn" onclick="filterArchivesByCategory('anime')">
                        <i class="fas fa-tv" style="color: var(--category-anime);"></i> Anime
                    </button>
                    <button class="filter-btn" onclick="filterArchivesByCategory('movies')">
                        <i class="fas fa-film" style="color: var(--category-movies);"></i> Movies
                    </button>
                    <button class="filter-btn" onclick="filterArchivesByCategory('software')">
                        <i class="fas fa-code" style="color: var(--category-software);"></i> Software
                    </button>
                    <button class="filter-btn" onclick="filterArchivesByCategory('books')">
                        <i class="fas fa-book" style="color: var(--category-books);"></i> Books
                    </button>
                    <button class="filter-btn" onclick="filterArchivesByCategory('games')">
                        <i class="fas fa-gamepad" style="color: var(--category-games);"></i> Games
                    </button>
                    <button class="filter-btn" onclick="filterArchivesByCategory('music')">
                        <i class="fas fa-music" style="color: var(--category-music);"></i> Music
                    </button>
                </div>

                <!-- Archives Table -->
                <div id="archivesTableContainer">
                    <div class="table-responsive">
                        <table class="archives-table" id="archivesTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th>Name</th>
                                    <th>URL</th>
                                    <th>Categories</th>
                                    <th>Search Pattern</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="archivesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Archive Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit" style="color: var(--accent-primary);"></i> Edit Archive</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="editArchiveForm">
                    <input type="hidden" id="editOriginalUrl">
                    
                    <div class="form-group">
                        <label for="editName">Archive Name *</label>
                        <input type="text" id="editName" required maxlength="100">
                    </div>

                    <div class="form-group">
                        <label for="editUrl">Website URL *</label>
                        <input type="text" id="editUrl" required maxlength="200">
                    </div>

                    <div class="form-group">
                        <label>Categories * (select one or more)</label>
                        <div class="checkbox-group" id="editCategoryCheckboxes" style="max-height: 250px;"></div>
                    </div>

                    <div class="form-group">
                        <label for="editSearchPattern">Search Pattern</label>
                        <input type="text" id="editSearchPattern" placeholder="/?s={query}" maxlength="200">
                    </div>

                    <div class="form-group">
                        <label for="editDescription">Description</label>
                        <textarea id="editDescription" rows="3" maxlength="500"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" form="editArchiveForm" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // ============================================
        // ENHANCED SECURITY MEASURES
        // ============================================
        
        // Disable right-click on admin panel (optional security)
        document.addEventListener('contextmenu', function(e) {
            if (window.location.pathname.includes('admin')) {
                e.preventDefault();
                showToast('Right-click disabled for security', 'warning');
            }
        });

        // Prevent inspect element shortcuts
        document.addEventListener('keydown', function(e) {
            if (window.location.pathname.includes('admin')) {
                // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                    (e.ctrlKey && e.shiftKey && e.key === 'J') || 
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                    showToast('Developer tools disabled for security', 'warning');
                }
            }
        });

        // Session management variables
        let sessionTimeout;
        let warningTimeout;
        let activityTimer;
        const SESSION_DURATION = 2 * 60 * 60 * 1000; // 2 hours
        const WARNING_BEFORE = 5 * 60 * 1000; // 5 minutes before expiry

        // ============================================
        // TOAST NOTIFICATION
        // ============================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <div style="flex: 1;">${message}</div>
                <i class="fas fa-times" style="cursor: pointer; opacity: 0.7; margin-left: var(--spacing-sm);" onclick="this.parentElement.remove()"></i>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 4000);
        }

        // ============================================
        // AUTHENTICATION & RATE LIMITING
        // ============================================
        
        const ADMIN_CREDENTIALS = {
            username: 'idiot-ghost3948',
            password: 'deepaks2727e888'
        };

        const MAX_LOGIN_ATTEMPTS = 5;
        const LOCKOUT_DURATION = 15 * 60 * 1000; // 15 minutes

        function getLoginAttempts() {
            return JSON.parse(localStorage.getItem('loginAttempts') || '{"count": 0, "lockoutUntil": null, "lastAttempt": null}');
        }

        function saveLoginAttempts(data) {
            localStorage.setItem('loginAttempts', JSON.stringify(data));
        }

        function isAccountLocked() {
            const attempts = getLoginAttempts();
            if (attempts.lockoutUntil && Date.now() < attempts.lockoutUntil) {
                return {
                    locked: true,
                    remainingTime: Math.ceil((attempts.lockoutUntil - Date.now()) / 60000)
                };
            }
            
            // Auto-unlock after lockout duration
            if (attempts.lockoutUntil && Date.now() >= attempts.lockoutUntil) {
                saveLoginAttempts({ count: 0, lockoutUntil: null, lastAttempt: null });
                return { locked: false };
            }
            
            return { locked: false };
        }

        function updateLoginAttemptsDisplay() {
            const attempts = getLoginAttempts();
            const attemptsLeft = MAX_LOGIN_ATTEMPTS - attempts.count;
            const displayEl = document.getElementById('loginAttempts');
            
            if (attempts.count > 0 && !attempts.lockoutUntil) {
                displayEl.textContent = `${attemptsLeft} login attempt(s) remaining`;
                displayEl.style.display = 'block';
            } else {
                displayEl.style.display = 'none';
            }
        }

        // ============================================
        // SESSION MANAGEMENT
        // ============================================
        
        function startSessionTimer() {
            const sessionStart = Date.now();
            const sessionEnd = sessionStart + SESSION_DURATION;
            
            // Store session end time
            localStorage.setItem('sessionEnd', sessionEnd.toString());
            
            // Update timer display
            updateSessionTimer();
            
            // Set timeout for session expiry
            sessionTimeout = setTimeout(() => {
                forceLogout('Session expired');
            }, SESSION_DURATION);
            
            // Set warning timeout
            warningTimeout = setTimeout(() => {
                showSessionWarning();
            }, SESSION_DURATION - WARNING_BEFORE);
            
            // Show session info
            document.getElementById('sessionInfo').style.display = 'flex';
            document.getElementById('activityIndicator').style.display = 'flex';
        }

        function updateSessionTimer() {
            const sessionEnd = parseInt(localStorage.getItem('sessionEnd'));
            if (!sessionEnd) return;
            
            const timer = setInterval(() => {
                const now = Date.now();
                const remaining = sessionEnd - now;
                
                if (remaining <= 0) {
                    clearInterval(timer);
                    document.getElementById('sessionTimer').textContent = 'Expired';
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('sessionTimer').textContent = `${minutes}m ${seconds}s`;
            }, 1000);
        }

        function showSessionWarning() {
            document.getElementById('timeoutWarning').classList.add('active');
            
            // Countdown in warning
            let timeLeft = 300; // 5 minutes in seconds
            const countdown = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('timeoutCountdown').textContent = `${mins}m ${secs}s`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    document.getElementById('timeoutWarning').classList.remove('active');
                }
            }, 1000);
        }

        function extendSession() {
            // Clear existing timeouts
            clearTimeout(sessionTimeout);
            clearTimeout(warningTimeout);
            
            // Reset session
            startSessionTimer();
            
            // Hide warning
            document.getElementById('timeoutWarning').classList.remove('active');
            
            showToast('Session extended for another 2 hours', 'success');
            
            // Log activity
            logSecurityEvent('Session extended');
        }

        function forceLogout(reason = 'Session expired') {
            // Clear all session data
            localStorage.removeItem('adminSession');
            localStorage.removeItem('sessionEnd');
            
            // Hide UI elements
            document.getElementById('sessionInfo').style.display = 'none';
            document.getElementById('activityIndicator').style.display = 'none';
            document.getElementById('timeoutWarning').classList.remove('active');
            
            // Show login overlay
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('adminContent').classList.remove('active');
            
            showToast(reason, 'warning');
            
            // Log security event
            logSecurityEvent('Auto logout', reason);
        }

        // Track user activity
        function trackActivity() {
            clearTimeout(activityTimer);
            activityTimer = setTimeout(() => {
                // User inactive for 30 minutes? Show warning
                if (document.getElementById('adminContent').classList.contains('active')) {
                    showToast('Are you still there? Session will expire soon', 'warning');
                }
            }, 25 * 60 * 1000); // 25 minutes
        }

        // Log security events
        function logSecurityEvent(event, details = '') {
            const events = JSON.parse(localStorage.getItem('securityLog') || '[]');
            events.push({
                event: event,
                details: details,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            });
            // Keep only last 50 events
            if (events.length > 50) events.shift();
            localStorage.setItem('securityLog', JSON.stringify(events));
        }

        // ============================================
        // LOGIN HANDLER
        // ============================================
        
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const lockStatus = isAccountLocked();
            if (lockStatus.locked) {
                document.getElementById('loginError').textContent = `ðŸ”’ Account locked. Try again in ${lockStatus.remainingTime} minutes.`;
                document.getElementById('loginError').style.display = 'block';
                logSecurityEvent('Locked login attempt');
                return;
            }

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            // Basic input sanitization
            if (!username || !password || username.length > 50 || password.length > 50) {
                showToast('Invalid input', 'error');
                return;
            }

            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                // Reset attempts on successful login
                saveLoginAttempts({ count: 0, lockoutUntil: null, lastAttempt: null });
                
                // Create secure session
                const session = {
                    id: generateSessionId(),
                    expiry: Date.now() + SESSION_DURATION,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('adminSession', JSON.stringify(session));
                
                // Hide login, show admin
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('adminContent').classList.add('active');
                
                // Start session timer
                startSessionTimer();
                
                // Initialize admin panel
                initializeAdmin();
                
                // Log successful login
                logSecurityEvent('Successful login');
                
                showToast('Secure login successful!', 'success');
            } else {
                // Handle failed login
                const attempts = getLoginAttempts();
                attempts.count += 1;
                attempts.lastAttempt = Date.now();

                const errorEl = document.getElementById('loginError');
                
                if (attempts.count >= MAX_LOGIN_ATTEMPTS) {
                    attempts.lockoutUntil = Date.now() + LOCKOUT_DURATION;
                    errorEl.textContent = `ðŸ”’ Too many failed attempts! Account locked for 15 minutes.`;
                    logSecurityEvent('Account locked', `${attempts.count} failed attempts`);
                } else {
                    const attemptsLeft = MAX_LOGIN_ATTEMPTS - attempts.count;
                    errorEl.textContent = `âŒ Invalid credentials! ${attemptsLeft} attempts remaining.`;
                }
                
                errorEl.style.display = 'block';
                saveLoginAttempts(attempts);
                updateLoginAttemptsDisplay();
                
                // Clear password field
                document.getElementById('password').value = '';
                
                // Log failed attempt
                logSecurityEvent('Failed login attempt', `Username: ${username}`);
            }
        });

        // Generate secure session ID
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
        }

        // ============================================
        // SESSION VALIDATION
        // ============================================
        
        function isAuthenticated() {
            const session = JSON.parse(localStorage.getItem('adminSession') || 'null');
            
            if (!session) return false;
            
            // Check if session expired
            if (Date.now() > session.expiry) {
                localStorage.removeItem('adminSession');
                localStorage.removeItem('sessionEnd');
                return false;
            }
            
            // Optional: Check if user agent matches (prevents session theft)
            if (session.userAgent !== navigator.userAgent) {
                localStorage.removeItem('adminSession');
                localStorage.removeItem('sessionEnd');
                logSecurityEvent('Session theft attempt detected');
                return false;
            }
            
            return true;
        }

        // ============================================
        // LOGOUT FUNCTION
        // ============================================
        
        function logout() {
            if (confirm('ðŸ”’ Secure Logout: Are you sure you want to end your session?')) {
                // Clear all session data
                localStorage.removeItem('adminSession');
                localStorage.removeItem('sessionEnd');
                
                // Clear timeouts
                clearTimeout(sessionTimeout);
                clearTimeout(warningTimeout);
                
                // Hide UI elements
                document.getElementById('sessionInfo').style.display = 'none';
                document.getElementById('activityIndicator').style.display = 'none';
                
                // Show login overlay
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('adminContent').classList.remove('active');
                
                // Log logout
                logSecurityEvent('Manual logout');
                
                showToast('Logged out securely', 'success');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (isAuthenticated()) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('adminContent').classList.add('active');
                startSessionTimer();
                initializeAdmin();
                
                // Log access
                logSecurityEvent('Admin panel accessed');
            }
            
            // Update login attempts display
            updateLoginAttemptsDisplay();
            
            // Handle mobile view
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.hide-mobile').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.show-mobile').forEach(el => el.style.display = 'inline');
            }
            
            // Start activity tracking
            trackActivity();
        });

        // Track user activity
        ['mousemove', 'keypress', 'click', 'scroll'].forEach(event => {
            window.addEventListener(event, trackActivity);
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.hide-mobile').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.show-mobile').forEach(el => el.style.display = 'inline');
            } else {
                document.querySelectorAll('.hide-mobile').forEach(el => el.style.display = 'inline');
                document.querySelectorAll('.show-mobile').forEach(el => el.style.display = 'none');
            }
        });

        // Security: Clear sensitive data on page hide
        window.addEventListener('pagehide', function() {
            // Optional: Clear any sensitive form data
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        // ============================================
        // CATEGORY MANAGEMENT (Same as before)
        // ============================================
        
        const CATEGORIES = [
            { id: 'anime', name: 'Anime', icon: 'fas fa-tv', color: '#ff6b6b' },
            { id: 'movies', name: 'Movies & TV', icon: 'fas fa-film', color: '#4ecdc4' },
            { id: 'software', name: 'Software', icon: 'fas fa-code', color: '#a8e6cf' },
            { id: 'books', name: 'Books & Comics', icon: 'fas fa-book', color: '#ffd93d' },
            { id: 'games', name: 'Games', icon: 'fas fa-gamepad', color: '#6c5ce7' },
            { id: 'music', name: 'Music', icon: 'fas fa-music', color: '#ff9ff3' },
            { id: 'other', name: 'Other', icon: 'fas fa-archive', color: '#8395a7' }
        ];

        let currentFilter = 'all';
        let selectedArchives = new Set();

        // Load archives from localStorage
        function loadArchives() {
            return JSON.parse(localStorage.getItem('archives') || '[]');
        }

        // Save archives to localStorage
        function saveArchives(archives) {
            localStorage.setItem('archives', JSON.stringify(archives));
        }

        // Initialize category checkboxes
        function initializeCategoryCheckboxes() {
            const container = document.getElementById('categoryCheckboxes');
            if (container) {
                container.innerHTML = CATEGORIES.map(cat => `
                    <div class="checkbox-item">
                        <input type="checkbox" id="cat_${cat.id}" value="${cat.id}">
                        <label for="cat_${cat.id}">
                            <i class="${cat.icon}" style="color: ${cat.color};"></i> ${cat.name}
                        </label>
                    </div>
                `).join('');
            }

            const editContainer = document.getElementById('editCategoryCheckboxes');
            if (editContainer) {
                editContainer.innerHTML = CATEGORIES.map(cat => `
                    <div class="checkbox-item">
                        <input type="checkbox" id="edit_cat_${cat.id}" value="${cat.id}">
                        <label for="edit_cat_${cat.id}">
                            <i class="${cat.icon}" style="color: ${cat.color};"></i> ${cat.name}
                        </label>
                    </div>
                `).join('');
            }
        }

        // Get selected categories
        function getSelectedCategories(prefix = '') {
            const selected = [];
            CATEGORIES.forEach(cat => {
                const checkbox = document.getElementById(`${prefix}cat_${cat.id}`);
                if (checkbox && checkbox.checked) {
                    selected.push(cat.id);
                }
            });
            return selected;
        }

        // Set selected categories
        function setSelectedCategories(categories, prefix = '') {
            CATEGORIES.forEach(cat => {
                const checkbox = document.getElementById(`${prefix}cat_${cat.id}`);
                if (checkbox) checkbox.checked = false;
            });
            
            if (categories && Array.isArray(categories)) {
                categories.forEach(catId => {
                    const checkbox = document.getElementById(`${prefix}cat_${catId}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Display category statistics
        function displayCategoryStats() {
            const archives = loadArchives();
            const container = document.getElementById('categoryStats');
            if (!container) return;
            
            const stats = CATEGORIES.map(category => {
                const count = archives.filter(a => 
                    a.categories && a.categories.includes(category.id)
                ).length;
                return { ...category, count };
            });

            container.innerHTML = stats.map(stat => `
                <div class="category-stat-card" style="border-left-color: ${stat.color};">
                    <div class="category-stat-header">
                        <div class="category-stat-icon" style="background: ${stat.color};">
                            <i class="${stat.icon}"></i>
                        </div>
                        <div>
                            <div class="category-stat-number">${stat.count}</div>
                            <div class="category-stat-label">Archives</div>
                        </div>
                    </div>
                    <div style="color: var(--text-primary); font-weight: 600; font-size: 0.9rem;">
                        ${stat.name}
                    </div>
                </div>
            `).join('');
        }

        // Display archives in table
        function displayArchives() {
            const archives = loadArchives();
            let filteredArchives = archives;
            
            if (currentFilter !== 'all') {
                filteredArchives = archives.filter(a => 
                    a.categories && a.categories.includes(currentFilter)
                );
            }
            
            const tableContainer = document.getElementById('archivesTableContainer');

            if (filteredArchives.length === 0) {
                tableContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“‚</div>
                        <h3>No Archives Found</h3>
                        <p style="color: var(--text-muted);">${currentFilter === 'all' ? 'Add your first archive using the form above!' : `No archives in this category`}</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            filteredArchives.forEach((archive, index) => {
                const isSelected = selectedArchives.has(archive.url);
                
                const categoryBadges = (archive.categories || ['other']).map(catId => {
                    const category = CATEGORIES.find(c => c.id === catId) || CATEGORIES[6];
                    return `
                        <span class="category-badge-table ${catId}">
                            <i class="${category.icon}"></i> ${category.name}
                        </span>
                    `;
                }).join('');
                
                html += `<tr>
                    <td data-label="Select">
                        <input type="checkbox" class="archive-checkbox" data-url="${archive.url}" ${isSelected ? 'checked' : ''} onchange="toggleArchiveSelection('${archive.url}', this.checked)">
                    </td>
                    <td data-label="Name"><strong>${escapeHtml(archive.name)}</strong></td>
                    <td data-label="URL">${escapeHtml(archive.url)}</td>
                    <td data-label="Categories">
                        <div class="category-badges-container">
                            ${categoryBadges}
                        </div>
                    </td>
                    <td data-label="Search Pattern">
                        <code style="background: var(--bg-card); padding: 4px 8px; border-radius: 4px;">${escapeHtml(archive.searchPattern || '/?s={query}')}</code>
                    </td>
                    <td data-label="Actions">
                        <div style="display: flex; gap: var(--spacing-sm);">
                            <button class="btn btn-primary btn-sm" onclick="editArchive('${archive.url}')" style="padding: var(--spacing-sm) var(--spacing-md);">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteArchive('${archive.url}')" style="padding: var(--spacing-sm) var(--spacing-md);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            tableContainer.innerHTML = `
                <div class="table-responsive">
                    <table class="archives-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"></th>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Categories</th>
                                <th>Search Pattern</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archivesTableBody">${html}</tbody>
                    </table>
                </div>
            `;
            
            displayCategoryStats();
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add new archive
        document.getElementById('addArchiveForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const name = document.getElementById('archiveName').value.trim();
            let url = document.getElementById('archiveUrl').value.trim();
            url = url.replace(/^https?:\/\//, '').replace(/\/$/, '');
            const categories = getSelectedCategories();
            const searchPattern = document.getElementById('archiveSearchPattern').value.trim();
            const description = document.getElementById('archiveDescription').value.trim();

            if (!name || !url) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }

            if (categories.length === 0) {
                showToast('Please select at least one category!', 'error');
                return;
            }

            const archives = loadArchives();
            
            if (archives.some(a => a.url === url)) {
                showToast('This URL already exists!', 'error');
                return;
            }

            archives.push({
                name: name,
                url: url,
                categories: categories,
                searchPattern: searchPattern || '/?s={query}',
                description: description,
                addedDate: new Date().toISOString()
            });

            saveArchives(archives);
            displayArchives();
            
            this.reset();
            CATEGORIES.forEach(cat => {
                const cb = document.getElementById(`cat_${cat.id}`);
                if (cb) cb.checked = false;
            });
            
            showToast(`âœ… "${name}" added successfully!`, 'success');
            logSecurityEvent('Archive added', name);
        });

        // Delete archive
        function deleteArchive(url) {
            const archives = loadArchives();
            const archive = archives.find(a => a.url === url);
            
            if (confirm(`Are you sure you want to delete "${archive?.name}"?`)) {
                const filtered = archives.filter(a => a.url !== url);
                saveArchives(filtered);
                displayArchives();
                selectedArchives.delete(url);
                showToast(`ðŸ—‘ï¸ "${archive?.name}" deleted`, 'info');
                logSecurityEvent('Archive deleted', archive?.name);
            }
        }

        // Edit archive
        function editArchive(url) {
            const archives = loadArchives();
            const archive = archives.find(a => a.url === url);
            
            if (!archive) return;
            
            document.getElementById('editOriginalUrl').value = archive.url;
            document.getElementById('editName').value = archive.name;
            document.getElementById('editUrl').value = archive.url;
            document.getElementById('editSearchPattern').value = archive.searchPattern || '';
            document.getElementById('editDescription').value = archive.description || '';
            
            setSelectedCategories(archive.categories || ['other'], 'edit_');
            
            const modal = document.getElementById('editModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close edit modal
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Save edit form
        document.getElementById('editArchiveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const originalUrl = document.getElementById('editOriginalUrl').value;
            const name = document.getElementById('editName').value.trim();
            let url = document.getElementById('editUrl').value.trim();
            url = url.replace(/^https?:\/\//, '').replace(/\/$/, '');
            const categories = getSelectedCategories('edit_');
            const searchPattern = document.getElementById('editSearchPattern').value.trim();
            const description = document.getElementById('editDescription').value.trim();
            
            if (!name || !url) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            
            if (categories.length === 0) {
                showToast('Please select at least one category!', 'error');
                return;
            }
            
            const archives = loadArchives();
            const index = archives.findIndex(a => a.url === originalUrl);
            
            if (index === -1) return;
            
            if (url !== originalUrl && archives.some(a => a.url === url)) {
                showToast('This URL already exists!', 'error');
                return;
            }
            
            archives[index] = {
                ...archives[index],
                name: name,
                url: url,
                categories: categories,
                searchPattern: searchPattern || '/?s={query}',
                description: description
            };
            
            saveArchives(archives);
            displayArchives();
            closeEditModal();
            showToast(`âœ… "${name}" updated successfully!`, 'success');
            logSecurityEvent('Archive updated', name);
        });

        // Filter archives by category
        function filterArchivesByCategory(categoryId) {
            currentFilter = categoryId;
            displayArchives();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event?.target) {
                event.target.classList.add('active');
            }
            
            const category = CATEGORIES.find(c => c.id === categoryId);
            showToast(`Showing ${category ? category.name : 'all'} archives`, 'info');
        }

        // Bulk add category
        function addBulkCategory() {
            const category = document.getElementById('bulkCategorySelect').value;
            
            if (!category) {
                showToast('Please select a category', 'warning');
                return;
            }
            
            if (selectedArchives.size === 0) {
                showToast('No archives selected', 'warning');
                return;
            }

            if (!confirm(`Add "${CATEGORIES.find(c => c.id === category)?.name}" category to ${selectedArchives.size} archive(s)?`)) {
                return;
            }

            const archives = loadArchives();
            archives.forEach(archive => {
                if (selectedArchives.has(archive.url)) {
                    if (!archive.categories) {
                        archive.categories = [];
                    }
                    if (!archive.categories.includes(category)) {
                        archive.categories.push(category);
                    }
                }
            });

            saveArchives(archives);
            displayArchives();
            showToast(`âœ… Category added to ${selectedArchives.size} archives`, 'success');
            logSecurityEvent('Bulk category add', `${category} to ${selectedArchives.size} archives`);
        }

        // Bulk remove category
        function removeBulkCategory() {
            const category = document.getElementById('bulkCategorySelect').value;
            
            if (!category) {
                showToast('Please select a category', 'warning');
                return;
            }
            
            if (selectedArchives.size === 0) {
                showToast('No archives selected', 'warning');
                return;
            }

            if (!confirm(`Remove "${CATEGORIES.find(c => c.id === category)?.name}" category from ${selectedArchives.size} archive(s)?`)) {
                return;
            }

            const archives = loadArchives();
            archives.forEach(archive => {
                if (selectedArchives.has(archive.url) && archive.categories) {
                    archive.categories = archive.categories.filter(c => c !== category);
                    if (archive.categories.length === 0) {
                        archive.categories = ['other'];
                    }
                }
            });

            saveArchives(archives);
            displayArchives();
            showToast(`âœ… Category removed from ${selectedArchives.size} archives`, 'success');
            logSecurityEvent('Bulk category remove', `${category} from ${selectedArchives.size} archives`);
        }

        // Selection functions
        function toggleArchiveSelection(url, selected) {
            if (selected) {
                selectedArchives.add(url);
            } else {
                selectedArchives.delete(url);
            }
            updateSelectAllCheckbox();
        }

        function selectAllArchives() {
            const checkboxes = document.querySelectorAll('.archive-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedArchives.add(cb.dataset.url);
            });
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) selectAll.checked = true;
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.archive-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedArchives.add(cb.dataset.url);
                } else {
                    selectedArchives.delete(cb.dataset.url);
                }
            });
        }

        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.archive-checkbox');
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                selectAll.checked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            }
        }

        // Initialize admin panel
        function initializeAdmin() {
            initializeCategoryCheckboxes();
            displayArchives();
            displayCategoryStats();
            selectedArchives.clear();
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
</body>
</html>